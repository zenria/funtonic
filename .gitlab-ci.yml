image: 'registry.scoopit.io/scoopit-runner'

before_script: 
  - cmake --version
  - wget https://github.com/Kitware/CMake/releases/download/v3.24.0-rc3/cmake-3.24.0-rc3-linux-x86_64.tar.gz
  - tar zxf cmake-3.24.0-rc3-linux-x86_64.tar.gz
  - mv cmake-3.24.0-rc3-linux-x86_64/bin/* ~/.bin
  - CMAKE_ROOT=/runnerusers/cmake-3.24.0-rc3-linux-x86_64/ cmake --version

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - rustup component add rustfmt
    - CMAKE_ROOT=/runnerusers/cmake-3.24.0-rc3-linux-x86_64/ cargo build --all --all-targets --color=always
    - CMAKE_ROOT=/runnerusers/cmake-3.24.0-rc3-linux-x86_64/ RUST_BACKTRACE=1 cargo test

release:
  stage: build
  only:
    - tags
  script:
    - rustup component add rustfmt
    - CMAKE_ROOT=/runnerusers/cmake-3.24.0-rc3-linux-x86_64/ cargo build --release --all --all-targets --color=always
    - CMAKE_ROOT=/runnerusers/cmake-3.24.0-rc3-linux-x86_64/ binrep push funtonic $CI_COMMIT_TAG target/release/executor target/release/taskserver target/release/commander
